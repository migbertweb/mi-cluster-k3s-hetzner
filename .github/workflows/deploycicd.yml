name: CI/CD Kustomize + KSOPS + Docker + Deploy + Telegram + Linters

on:
  push:
    branches:
      - master
    paths:
      - "apps/deployCICD/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/deployCICD

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configurar Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      # Generacion de nuevo tag semÃ¡ntico
      - name: Generar nuevo tag semÃ¡ntico
        id: tag
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GH_PAT }}
          release_branches: master
          tag_prefix: "v"
          default_bump: patch
      # creacion de imagen docker para amd64 y arm64
      - name: Configurar Buildx para multi-arch
        uses: docker/setup-buildx-action@v3

      - name: Login a DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build y push multiplataforma (amd64 + arm64)
        uses: docker/build-push-action@v5
        with:
          context: ./apps/deployCICD
          file: ./apps/deployCICD/Dockerfile
          push: true
          platforms: linux/arm64 # linux/amd64 despues agrego para amd64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/php-redis-app:${{ steps.tag.outputs.new_tag }}
            ${{ secrets.DOCKER_USERNAME }}/php-redis-app:latest
      # instalacion de herramientas necesarias
      - name: Instalar Kustomize y KSOPS
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

          mkdir -p ~/.config/kustomize/plugin/viaduct.ai/v1/ksops
          curl -Lo ksops https://github.com/viaduct-ai/kustomize-sops/releases/latest/download/ksops-linux-amd64
          chmod +x ksops
          mv ksops ~/.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops

      - name: Instalar Age y SOPS
        run: |
          curl -L https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz | tar xz
          sudo mv age/age /usr/local/bin/
          sudo mv age/age-keygen /usr/local/bin/

          curl -L https://github.com/mozilla/sops/releases/download/v3.8.1/sops-v3.8.1.linux -o /usr/local/bin/sops
          chmod +x /usr/local/bin/sops

      - name: Configurar clave privada de Age
        run: |
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
      # actualizar tag en kustomization.yaml
      - name: Actualizar tag en kustomization.yaml
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/php-redis-app
          TAG=${{ steps.tag.outputs.new_tag }}
          ls -la
          cd k8s/base
          kustomize edit set image $IMAGE=$IMAGE:$TAG

      - name: Hacer commit y push del nuevo tag
        run: |
          git add k8s/base/kustomization.yaml
          git commit -m "chore: update image tag to ${{ steps.tag.outputs.new_tag }}"
          git push origin master

      - name: Configurar Kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig.yaml
          export KUBECONFIG=$PWD/kubeconfig.yaml

      - name: Lint con kube-linter
        run: |
          curl -sSL https://github.com/stackrox/kube-linter/releases/latest/download/kube-linter-linux.tar.gz | tar xz
          ./kube-linter lint <(kustomize build .)

      - name: ValidaciÃ³n con kubeval
        run: |
          curl -LO https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar -xzf kubeval-linux-amd64.tar.gz
          ./kubeval --strict --exit-on-error <(kustomize build .)
      # revisar
      - name: Aplicar despliegue al clÃºster
        env:
          KUBECONFIG: ${{ github.workspace }}/apps/deployCICD/kubeconfig.yaml
        run: |
          kustomize build  apps/deployCICD/k8s/overlays/prod | kubectl apply -f -
      ## Mensajes de notificaciÃ³n por Telegram
      # exitoso
      - name: NotificaciÃ³n por Telegram (Ã©xito)
        if: success()
        run: |
          START_TIME=$(date -d "${{ github.event.head_commit.timestamp }}" +%s)
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          FORMATTED_FILES=$(echo "$CHANGED_FILES" | sed '/^$/d' | sed 's/^/â€¢ /')

          MESSAGE="âœ… *Deploy exitoso*\n\n
          ðŸ“¦ *VersiÃ³n:* \`${{ steps.tag.outputs.new_tag }}\`\n
          ðŸš€ *Proyecto:* [${{ github.repository }}](https://github.com/${{ github.repository }})\n
          ðŸŒ¿ *Rama:* \`${{ github.ref_name }}\`\n
          ðŸ” *Commit:* [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n
          ðŸ•’ *DuraciÃ³n:* \`${DURATION}s\`\n\n
          ðŸ§¾ *Archivos modificados:*\n$FORMATTED_FILES"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="$MESSAGE"
      # fallo
      - name: NotificaciÃ³n por Telegram (fallo)
        if: failure()
        run: |
          START_TIME=$(date -d "${{ github.event.head_commit.timestamp }}" +%s)
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          EXIT_CODE=$?

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          FORMATTED_FILES=$(echo "$CHANGED_FILES" | sed '/^$/d' | sed 's/^/â€¢ /')

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="âŒ *Error en Deploy*

          ðŸš€ *Proyecto:* [${{ github.repository }}](https://github.com/${{ github.repository }})
          ðŸŒ¿ *Rama:* \`${{ github.ref_name }}\`
          ðŸ” *Commit:* [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          ðŸ•’ *DuraciÃ³n:* \`${DURATION}s\`
          ðŸ’¥ *CÃ³digo de error:* \`${EXIT_CODE}\`

          ðŸ§¾ *Archivos modificados:*
          $FORMATTED_FILES"
